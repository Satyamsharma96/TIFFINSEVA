<!-- ===================== CHATBOT PARTIAL ===================== -->
<style>


  #chatbot-header {
  position: relative;
  padding: 10px;
  background: #ff7675;
  color: white;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#chatbot-close {
  cursor: pointer;
  font-size: 18px;
  padding: 0 8px;
  transition: 0.2s;
}

#chatbot-close:hover {
  color: #333;
  transform: scale(1.2);
}


  /* Floating button */
  #chatbot-button {
    position: fixed;
    bottom: 25px;
    right: 25px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #ff6b6b, #f06595);
    border-radius: 50%;
    border: none;
    outline: none;
    color: #fff;
    font-size: 28px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    z-index: 1000;
    transition: all 0.3s ease;
  }

  #chatbot-button:hover {
    transform: scale(1.1);
  }

  /* Chatbox container */
  #chatbot-container {
    position: fixed;
    bottom: 100px;
    right: 10px;
    width: 350px;
    max-height: 500px;
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.3s ease-out;
    z-index: 1000;
  }

  @keyframes slideUp {
    from {
      transform: translateY(30px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  #chatbot-header {
    background: linear-gradient(135deg, #f06595, #ff6b6b);
    color: white;
    padding: 12px 16px;
    font-weight: bold;
    text-align: center;
  }

  #chatbot-body {
    flex: 1;
    padding: 10px 15px;
    overflow-y: auto;
    background-color: #f9fafb;
  }

  .message {
    display: inline-block;
    clear: both;
    padding: 10px 14px;
    border-radius: 15px;
    margin: 6px 0;
    line-height: 1.3;
    max-width: 80%;
    word-wrap: break-word;
  }

  .bot {
    background: #e9ecef;
    float: left;
  }

  .user {
    background: #ff6b6b;
    color: white;
    float: right;
  }

  #chatbot-input {
    display: flex;
    align-items: center;
    padding: 10px;
    background: #f1f3f5;
  }

  #chatbot-input input {
    flex: 1;
    border: none;
    border-radius: 20px;
    padding: 10px 14px;
    outline: none;
  }

  #chatbot-input button {
    border: none;
    background: none;
    color: #ff6b6b;
    font-size: 22px;
    cursor: pointer;
    margin-left: 5px;
  }

  .option-btn {
    display: inline-block;
    background: #fff;
    border: 1px solid #ff6b6b;
    color: #ff6b6b;
    padding: 5px 10px;
    border-radius: 12px;
    margin: 5px 3px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
  }

  .option-btn:hover {
    background: #ff6b6b;
    color: #fff;
  }
  @media (max-width: 1050px) {
    #chatbot-button{
        bottom: 95px;
    }
  }
</style>

<!-- Floating Chat Icon -->
<button id="chatbot-button"><i class="fa fa-comments"></i></button>

<!-- Chatbot Container -->
<div id="chatbot-container">
  <div id="chatbot-header">
  Tiffin Seva Assistant üç±
  <span id="chatbot-close">‚úñ</span>
</div>
  <div id="chatbot-body"></div>
  <div id="chatbot-input">
    <input type="text" id="chatInput" placeholder="Type your message..." />
    <button id="sendBtn"><i class="fa fa-paper-plane"></i></button>
  </div>
</div>

<script>
  const chatbotButton = document.getElementById('chatbot-button');
  const chatbotContainer = document.getElementById('chatbot-container');
  const chatBody = document.getElementById('chatbot-body');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');

  let botData = null;

  // Inject userType from EJS backend (default to null if not logged in)
  const userType = "<%= user ? user.userType : null %>";

  // Load chatbot data
  fetch('/js/tiffinBotData.json')
    .then(res => res.json())
    .then(data => botData = data)
    .catch(err => console.error('Failed to load bot data:', err));

  // Toggle chatbot visibility
  chatbotButton.addEventListener('click', () => {
    const isVisible = chatbotContainer.style.display === 'flex';
    chatbotContainer.style.display = isVisible ? 'none' : 'flex';

    // First open greeting
    if (!isVisible && chatBody.innerHTML.trim() === '') {
      if (!userType) {
        // üîπ Not logged in
        showMessage("üëã Hello! Welcome to Tiffin Seva. Please log in or sign up to continue.", "bot");
        showOptions([
          { text: "Customer Login", link: "/logIn" },
          { text: "Customer Signup", link: "/signup-customer" },
          { text: "Vendor Signup", link: "/signup-vendor" }
        ]);
      } else if (userType === "vender") {
        // üîπ Vendor
        const greeting = botData?.vendor?.greeting;
        if (greeting) {
          showMessage(greeting.message, "bot");
          showOptions(greeting.options);
        } else {
          showMessage("Welcome Vendor üëã How can I assist you today?", "bot");
        }
      } else {
        // üîπ Customer
        const greeting = botData?.customer?.greeting;
        if (greeting) {
          showMessage(greeting.message, "bot");
          showOptions(greeting.options);
        } else {
          showMessage("Hello! üëã Welcome to Tiffin Seva. How can I help you today?", "bot");
        }
      }
    }
  });

  // Handle send button and Enter key
  sendBtn.addEventListener('click', handleUserInput);
  chatInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') handleUserInput();
  });

  // Handle user input
  function handleUserInput() {
    const msg = chatInput.value.trim();
    if (!msg) return;
    showMessage(msg, 'user');
    chatInput.value = '';
    setTimeout(() => processMessage(msg.toLowerCase()), 500);
  }

  // Show messages
  function showMessage(text, sender = 'bot') {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', sender);
    msgDiv.innerHTML = text;
    chatBody.appendChild(msgDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // Show clickable options (buttons)
  function showOptions(optionsArray) {
    const container = document.createElement('div');
    optionsArray.forEach(opt => {
      const btn = document.createElement('button');
      btn.classList.add('option-btn');
      btn.innerText = opt.text;
      btn.onclick = () => window.location.href = opt.link;
      container.appendChild(btn);
    });
    chatBody.appendChild(container);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // Main logic to process message
  function processMessage(msg) {
  if (!botData) {
    showMessage("‚ö†Ô∏è Bot data not loaded yet. Please wait...", "bot");
    return;
  }

  // üîπ If not logged in
  if (!userType) {
    // Allow ‚Äúabout tiffin seva‚Äù to work even when logged out
    const aboutData = botData["about_tiffin_seva"];
    if (aboutData && aboutData.keywords.some(k => msg.includes(k))) {
      showMessage(aboutData.message, "bot");
      if (aboutData.options?.length) showOptions(aboutData.options);
      return;
    }

    showMessage("You are not logged in yet. Please login or sign up first.", "bot");
    showOptions([
      { text: "Login", link: "/logIn" },
      { text: "Customer Signup", link: "/signup-customer" },
      { text: "Vendor Signup", link: "/signup-vendor" }
    ]);
    return;
  }

  // üîπ Determine if user is vendor or customer
  const category = userType === "vender" ? "vendor" : "customer";
  const responses = botData[category];
  let matched = false;

  // Check all main sections
  for (const key in responses) {
    const data = responses[key];
    if (data.keywords.some(k => msg.includes(k))) {
      matched = true;
      showMessage(data.message, "bot");
      if (data.options?.length) showOptions(data.options);
      return;
    }
  }

  // Check ‚Äúabout_tiffin_seva‚Äù subtopics (mission/vision)
  const aboutData = botData["about_tiffin_seva"];
  if (aboutData) {
    if (aboutData.keywords.some(k => msg.includes(k))) {
      matched = true;
      showMessage(aboutData.message, "bot");
      if (aboutData.options?.length) showOptions(aboutData.options);
      return;
    }
    // Subtopics
    for (const sub in aboutData.subtopics) {
      if (msg.includes(sub)) {
        matched = true;
        showMessage(aboutData.subtopics[sub].message, "bot");
        return;
      }
    }
  }

  // Default fallback
  if (!matched) {
    showMessage("ü§î I‚Äôm not sure about that. Try asking about meals, bookings, or help.", "bot");
  }
}


const closeBtn = document.getElementById('chatbot-close');

closeBtn.addEventListener('click', () => {
  chatbotContainer.style.display = 'none';
});
</script>
