<%- include('../partials/head') %>
  <%- include('../partials/nav') %>
    <%- include('../partials/deliveringMsg') %>

      <!-- ðŸŒŸ Hero Section -->
      <section class="hero-section">
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <h1 class="hero-title">Delicious Tiffins, Delivered Daily</h1>
          <p class="hero-subtitle">Fresh, home-style meals from the best vendors in Lucknow.</p>
          <a href="#vendors-list" class="hero-btn">Explore Menu</a>
        </div>

        <div class="scroll-down">
          <a href="#vendors-list">
            <p class="scroll-text">Scroll Down</p>
            <span></span>
            <span></span>
            <span></span>
          </a>
        </div>
      </section>

      <!-- ðŸ± Vendors Section -->
      <section id="vendors-list" class="container" style="margin-top: 60px;">
        <div class="section-header">
          <h2>Our Top Vendors</h2>
          <p style="color: #636e72; margin-top: 10px;">Choose from a variety of authorized tiffin services nearby</p>
        </div>

        <div class="vendors-grid">
          <% if (venders.length===0) { %>
            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
              <img src="/list.png" alt="No vendors" style="width: 60px; margin: 0 auto 20px; opacity: 0.5;">
              <h3 style="color: #888;">No vendors currently available nearby.</h3>
              <p style="color: #aaa;">Try adjusting your location preferences.</p>
            </div>
            <% } else { %>
              <% venders.forEach((vender)=> { %>
                <div class="vendor-card">
                  <a href="/user/vender-list/<%= vender._id %>"
                    style="display: block; height: 100%; display: flex; flex-direction: column;">
                    <div class="vendor-img-wrapper">
                      <% const bannerSrc=(vender.bannerImage && vender.bannerImage.trim() !=='' ) ? vender.bannerImage
                        : '/tiffin.png' ; %>
                        <img src="<%= bannerSrc %>" alt="<%= vender.serviceName %>"
                          class="vendor-img <%= vender.hasMenu ? '' : 'filter-gray' %>">
                        <% if (!vender.hasMenu) { %>
                          <div
                            style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; font-size: 0.8rem; border-radius: 4px;">
                            Currently Unavailable</div>
                          <% } %>
                    </div>

                    <div class="vendor-body">
                      <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 class="vendor-title" style="margin-bottom: 0; flex: 1; padding-right: 10px;">
                          <%= vender.serviceName %>
                        </h3>
                        <% let avgRating="New" ; let ratingColor="#fab1a0" ; if (vender.reviews &&
                          vender.reviews.length> 0) {
                          let total = vender.reviews.reduce((sum, review) => sum + review.rating, 0);
                          avgRating = (total / vender.reviews.length).toFixed(1);

                          if (avgRating >= 4) { ratingColor = "#27ae60"; }
                          else if (avgRating >= 3) { ratingColor = "#f1c40f"; }
                          else { ratingColor = "#e74c3c"; }
                          }
                          %>
                          <span
                            style="background: <%= ratingColor %>; color: white; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); white-space: nowrap;">
                            <%= avgRating %> <i class="fas fa-star" style="font-size: 0.75rem;"></i>
                          </span>
                      </div>
                      <div class="vendor-info">
                        <span><i class="fas fa-map-marker-alt" style="color: var(--primary-color); width: 20px;"></i>
                          <%= vender.location ? vender.location.substring(0, 25) + '...' : 'Lucknow' %>
                        </span>
                      </div>
                      <div class="vendor-info">
                        <span><i class="fas fa-rupee-sign" style="color: var(--secondary-color); width: 20px;"></i>
                          <span class="price-tag">
                            <%= vender.pricePerDay || 0 %>/meal
                          </span>
                        </span>
                      </div>

                      <div class="vendor-actions">
                        <!-- Empty spacer for space-between -->
                        <div></div>

                        <div style="display: flex; align-items: center; gap: 10px;">

                          <% if (showOptions) { %>
                            <form action="/user/favourite_list" method="post" style="display: inline-block;">
                              <input type="hidden" name="venderId" value="<%= vender._id %>">
                              <button type="submit" class="fav-btn-icon" onclick="event.stopPropagation(); loading();">
                                <% if (opacity[vender._id]==10) { %>
                                  <img src="/pngtree-red-3d-heart-emoji-realistic-shadow-png-image_4539964.png"
                                    alt="Favorited">
                                  <% } else { %>
                                    <img src="/pngtree-red-3d-heart-emoji-realistic-shadow-png-image_4539964.png"
                                      style="filter: grayscale(100%);" alt="Add to Favorites">
                                    <% } %>
                              </button>
                            </form>
                            <% } %>
                        </div>
                      </div>
                    </div>
                  </a>
                </div>
                <% }) %>
                  <% } %>
        </div>
      </section>

      <!-- âœ¨ Features Section -->
      <section class="features-section">
        <div class="container">
          <div class="section-header" style="margin-top: 0; margin-bottom: 20px;">
            <h2>Why Choose Tiffin Seva?</h2>
            <p style="color: #636e72;">Good food, good mood, delivered to your doorstep.</p>
          </div>

          <div class="features-grid">
            <div class="feature-item">
              <div class="feature-icon"><i class="fas fa-check-circle"></i></div>
              <h3 class="feature-title">Verified Vendors</h3>
              <p class="feature-desc">All our vendors are verified for quality and hygiene standards.</p>
            </div>
            <div class="feature-item">
              <div class="feature-icon"><i class="fas fa-utensils"></i></div>
              <h3 class="feature-title">Homely Taste</h3>
              <p class="feature-desc">Enjoy food that tastes just like home, made with love.</p>
            </div>
            <div class="feature-item">
              <div class="feature-icon"><i class="fas fa-truck"></i></div>
              <h3 class="feature-title">Reliable Delivery</h3>
              <p class="feature-desc">Timely delivery ensuring your food reaches you hot and fresh.</p>
            </div>
            <div class="feature-item">
              <div class="feature-icon"><i class="fas fa-wallet"></i></div>
              <h3 class="feature-title">Affordable Plans</h3>
              <p class="feature-desc">Flexible subscription models â€“ daily, weekly, or monthly.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ðŸŽ Offers Section -->
      <section class="container offers-section-modern">
        <div class="section-header" style="margin-top: 0; margin-bottom: 20px;">
          <h2>Special Offers</h2>
        </div>

        <div class="offers-grid">
          <div class="offer-card-modern">
            <div class="offer-badge-modern">New!</div>
            <h3 class="offer-title">Flat 5% Off</h3>
            <p>Subscribe for 3+ months and get an instant 5% discount on your total bill.</p>
          </div>

          <div class="offer-card-modern">
            <div class="offer-badge-modern">Daily Alert</div>
            <h3 class="offer-title">Never Miss a Meal</h3>
            <p>Get automated reminders 1 hour before your meal time.</p>
          </div>

          <div class="offer-card-modern">
            <div class="offer-badge-modern">Birthday Special</div>
            <h3 class="offer-title">â‚¹100 Gift</h3>
            <p>Active subscribers get â‚¹100 added to their welcome offer on their birthday! ðŸŽ‚</p>
          </div>
        </div>

        <% if (user && user.userType==='guest' && user.welcomeOffer.amount> 0 && !user.welcomeOffer.isUsed) { %>
          <div
            style="margin-top: 40px; background: #fffbe6; border: 1px solid #ffe58f; padding: 20px; border-radius: 12px; text-align: center;">
            <h3 style="color: #faad14;">ðŸŽ‰ Special Welcome Offer!</h3>
            <p>You have <strong>â‚¹<%= user.welcomeOffer.amount %> OFF</strong> available for your first monthly
              subscription.</p>
          </div>
          <% } %>
      </section>

      <!-- ðŸ“± App Section Placeholder (Preserving original intent) -->
      <section style="background-color: #f9f9f9; padding: 60px 0;">
        <div class="container"
          style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 300px; padding-right: 20px;">
            <h2 style="font-size: 2.5rem; margin-bottom: 20px; color: #333;">Get the App</h2>
            <p style="font-size: 1.1rem; color: #555; margin-bottom: 30px;">Order tiffins on the go. Our mobile app is
              coming soon with live tracking and exclusive app-only deals.</p>
            <div style="display: flex; gap: 15px;">
              <button
                style="background: #333; color: white; padding: 10px 20px; border-radius: 8px; border: none; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <i class="fab fa-apple" style="font-size: 1.5rem;"></i>
                <div style="text-align: left; line-height: 1;"><small>Coming Soon to</small><br><strong>App
                    Store</strong></div>
              </button>
              <button
                style="background: #333; color: white; padding: 10px 20px; border-radius: 8px; border: none; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <i class="fab fa-google-play" style="font-size: 1.5rem;"></i>
                <div style="text-align: left; line-height: 1;"><small>Coming Soon to</small><br><strong>Google
                    Play</strong></div>
              </button>
            </div>
          </div>
          <div style="flex: 1; min-width: 300px; text-align: center; padding-top: 20px;">
            <!-- Using a generic phone mockup or the mainLogo if no app image exists -->
            <img src="/mainLogo.png" alt="App Mockup"
              style="max-height: 300px; display: inline-block; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1));">
          </div>
        </div>
      </section>

      <%- include('../partials/loading') %>
        <%- include('../partials/footer') %>

          <!-- Script Logic (Preserved) -->
          <input type="hidden" id="birthdayMessage" value="<%= birthdayMessage || '' %>">
          <input type="hidden" id="welcomeOfferMessage" value="<%= welcomeOfferMessage || '' %>">
          <input type="hidden" id="guestAlert" value='<%= JSON.stringify(guestAlert || {}) %>' />
          <input type="hidden" id="vendorAlert" value='<%= JSON.stringify(vendorAlert || {}) %>' />
          <input type="hidden" id="userName" value="<%= user ? user.firstName : '' %>" />

          <script>
            // Loading function (if not defined elsewhere)
            function loading() {
              const loader = document.getElementById('loading-overlay');
              // assuming partials/loading has an ID, usually it does or just shows up.
              // Ideally this function is global or in layout, but standard per original code:
              if (document.querySelector('.loading')) document.querySelector('.loading').style.display = 'flex';
            }

            document.addEventListener('DOMContentLoaded', async () => {
              // ðŸŽ‚ Birthday & Welcome Logic
              const birthdayMsg = document.getElementById('birthdayMessage').value;
              const offerMsg = document.getElementById('welcomeOfferMessage').value;

              if (birthdayMsg) {
                Swal.fire({
                  title: 'ðŸŽ‰ Happy Birthday!',
                  text: birthdayMsg,
                  icon: 'success',
                  confirmButtonText: 'Thanks!',
                  confirmButtonColor: '#FF4D4F',
                  backdrop: `rgba(0,0,123,0.4)`
                }).then(() => {
                  if (offerMsg) {
                    Swal.fire({
                      title: 'ðŸŽ Birthday Gift!',
                      text: offerMsg,
                      icon: 'info',
                      confirmButtonText: 'Awesome!',
                      confirmButtonColor: '#28a745'
                    });
                  }
                });
              } else if (offerMsg) {
                Swal.fire({
                  title: 'ðŸŽ Welcome Offer!',
                  text: offerMsg,
                  icon: 'success',
                  confirmButtonText: 'Okay',
                  confirmButtonColor: '#FF4D4F'
                });
              }

              // ðŸ”” Alerts Logic
              const guestAlert = JSON.parse(document.getElementById("guestAlert").value || "{}");
              const vendorAlert = JSON.parse(document.getElementById("vendorAlert").value || "{}");
              const userName = document.getElementById("userName").value;

              // Small delay to let other popups settle
              await new Promise(resolve => setTimeout(resolve, 800));

              if (guestAlert && guestAlert.message) {
                Swal.fire({
                  title: `Hey ${userName} ðŸ‘‹`,
                  text: guestAlert.message,
                  icon: 'info',
                  showCancelButton: true,
                  confirmButtonText: guestAlert.btnText || 'OK',
                  cancelButtonText: 'Close',
                  confirmButtonColor: '#3085d6'
                }).then((res) => {
                  if (res.isConfirmed && guestAlert.redirect) window.location.href = guestAlert.redirect;
                });
              }

              if (vendorAlert && vendorAlert.message) {
                Swal.fire({
                  title: 'Hello Chef ðŸ‘¨â€ðŸ³',
                  text: vendorAlert.message,
                  icon: 'success',
                  showCancelButton: true,
                  confirmButtonText: vendorAlert.btnText || 'OK',
                  cancelButtonText: 'Later',
                  confirmButtonColor: '#28a745'
                }).then((res) => {
                  if (res.isConfirmed && vendorAlert.redirect) window.location.href = vendorAlert.redirect;
                });
              }
            });
          </script>
          <%- include('../partials/_chatbot') %>